{\bfseries{Dr. Chen-\/\+Hanson Ting}}, the name often associated with {\bfseries{e\+Forth}} and one of the inspiring figures of Forth community, wrote\+: $>$$\ast$\+In all these years, I have thought that the e\+Forth Model is a good model useful for all different processors and microcontrollers, and for all different applications. It is a very simple model for anybody who like to learn Forth and to use it for their own applications.$\ast$

In 2011, Dr. Ting created \href{https://chochain.github.io/eForth1/ref/328eForth.pdf}{\texttt{ $\ast$328e\+Forth$\ast$}} to run Forth on Arduino U\+NO and wrote in his ce\+Forth\+\_\+33 document\+: \begin{quote}
{\itshape I was attracted to Arduino Uno Kit and ported e\+Forth to it as 328e\+Forth...writing to flash memory, I had to take over the bootload section which was monopolized by Arduino I\+DE...I extended Forth dictionary in the R\+AM memory. It worked. ...., it was only a teaser to entice new people to try Forth on Arduino Uno.} \end{quote}


Personnally, I enjoyed the beauty of working on something small and simple, so decided to pick up Dr. Ting\textquotesingle{}s e\+Forth Model to push it beyond being a teaser. Here we go...

\doxysubsection*{What is e\+Forth1?}


\begin{DoxyItemize}
\item An e\+Forth for Arduino U\+N\+O/\+Nano implemented in C.
\item .ino sketch file can be openned in Arduino I\+DE, no programmer to overwrite bootloader needed.
\item Has 16-\/bit cells and stacks.
\item Can read/write Arduino G\+P\+IO pins.
\item Supports Arduino Timer and Pin Change Interrupts.
\item Has C A\+PI to interface with user defined functions written in .ino.
\item Can save/restore app to/from E\+E\+P\+R\+OM.
\item Can be embeded with other Arduino applications.
\item Can become a turnkey system booting from saved E\+E\+P\+R\+OM or enscripted Forth code.
\end{DoxyItemize}

\doxysubsection*{How to install e\+Forth1?}


\begin{DoxyItemize}
\item From Arduino I\+DE\textquotesingle{}s Library Manager \begin{quote}


Make sure you\textquotesingle{}ve hooked up one of Arduino Nano/\+Uno, or a development board that hosts A\+Tmega328

$>$ from {\itshape Arduino I\+DE $>$ Tools $>$ Manage} Libraries, enter F\+O\+R\+TH in search box

$>$ find e\+Forth1 in the short list, select the latest version, and click the Install button

$>$ from {\itshape Files $>$ Examples}, find e\+Forth1 in Examples from Custom Libraries at very buttom section

$>$ load one of the e\+Forth1 examples, such as {\itshape 0\+\_\+hello}

$>$ open Serial Monitor, set baud rate to {\itshape 115200}, and line ending to {\itshape Both NL \& CR}

$>$ hit compile and upload. You should see the \textquotesingle{}ok\textquotesingle{} prompt

\end{quote}

\item Or, from Git\+Hub directly, if you prefer managing source codes manually \begin{quote}


$>$ git clone \href{https://github.com/chochain/eForth1}{\texttt{ $\ast$https\+://github.com/chochain/e\+Forth1$\ast$}} onto your local Sketch directory

$>$ copy {\itshape examples/0\+\_\+hello/0\+\_\+hello.\+ino} from sub-\/directory, then rename it as {\itshape \mbox{\hyperlink{eforth1_8ino}{eforth1.\+ino}}}

$>$ open {\itshape \mbox{\hyperlink{eforth1_8ino}{eforth1.\+ino}}} with Arduino I\+DE, and setup your Nano/\+Uno (or A\+Tmega328) development board

$>$ in {\itshape \mbox{\hyperlink{eforth1_8ino}{eforth1.\+ino}}}, change the {\itshape \#include $<$eforth1.\+h$>$} to {\itshape \#include \char`\"{}./src/eforth1.\+h\char`\"{}}

$>$ open Serial Monitor, set baud rate to {\itshape 115200}, and line ending to {\itshape Both NL \& CR}

$>$ compile and upload, you should see the \textquotesingle{}ok\textquotesingle{} prompt

\end{quote}

\end{DoxyItemize}

Hopefully, thing goes well and you get something like the snip below if e\+Forth1 is uploaded successfully.


\begin{DoxyItemize}
\item $>$ ~\newline

\end{DoxyItemize}

Now type {\bfseries{W\+O\+R\+DS}} in the input bar and hit $<$return$>$ to list all the words supprted by e\+Forth1. It is ready to serve your future fun projects.


\begin{DoxyItemize}
\item $>$ 
\end{DoxyItemize}

\doxysubsection*{Different from Dr. Ting\textquotesingle{}s}


\begin{DoxyItemize}
\item Instead of the original 32-\/bit, C\+E\+LL is 16-\/bit, and prmitives are 8-\/bit opcodes.
\item To save space, primitives are compiled as bytecode and composite words are flagged address pointers.
\item For speed, use direct threading model instead of original subroutine threaded,
\item Instead of raw G\+P\+IO port read/write, e\+Forth1 calls Arduino library functions i.\+g. P\+I\+N\+M\+O\+DE = pin\+Mode, IN = digital\+Read, O\+UT = digital\+Write, ...
\item Support multi-\/tasking. Timer2 sliced at 1ms as the heart-\/beat with 8 I\+SR handler slots provided which Forth words can be assigned to. Timer1 is left free for Servo or other libraries.
\item Support Delay (sleep). It does not pause the M\+CU nor does it interfer with interrupts. 16-\/bit delay max 32767ms, longer delay can be have by defining word that loops.
\item Support Pin Change Interrupts. I\+SR handler slots are provided for each of Port B,C, and D.
\item Support 32-\/bit clock (in ms). It takes 2 cells off 16-\/bit stack. Arithmetics for double are also provided. D\+N\+E\+G\+A\+TE, D+, or D-\/ plus the conversion words D$>$S, S$>$D.
\end{DoxyItemize}

\doxysubsection*{Demos}


\begin{DoxyItemize}
\item L\+ED blinker (assume you have a blue L\+ED on pin 6, or try \href{https://wokwi.com/projects/356793878308297729}{\texttt{ $\ast$this Wokwi project$\ast$}}) 
\begin{DoxyPre}
    > 1 6 PINMODE⏎                           \textbackslash{} set pin 6 for OUTPUT, i.e. pinMode(6, OUTPUT=1)
    > : blue 6 IN 1 XOR 6 OUT ;⏎             \textbackslash{} create a word to toggle the blue LED
    > : blink FOR blue 500 DELAY NEXT ;⏎     \textbackslash{} create a word to blink (i.e. 500ms delay)
    > 9 blink⏎                               \textbackslash{} run 10 cycles (i.e. 9,8,7,...,2,1,0 to on/off 5 times)
    \end{DoxyPre}

\item Timer Interrupt Service Routine (a red L\+ED on pin 5) 
\begin{DoxyPre}
    > 1 5 PINMODE⏎                           \textbackslash{} set pin 5 for OUTPUT
    > : red 5 IN 1 XOR 5 OUT ;⏎              \textbackslash{} create an interrupt service routine (just a regular word)
    > ' red 200 0 TMISR⏎                     \textbackslash{} make the ISR ticked every 0.2 seconds (= 200ms)
    > 1 TIMER⏎                               \textbackslash{} enable timer, now you should see red LED blinking continuously
    > 19 blink⏎                              \textbackslash{} let's have them both blink (blue LED 10 times) 
    \end{DoxyPre}

\end{DoxyItemize}

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{2}{|X[-1]}|}
\hline
\cellcolor{\tableheadbgcolor}\textbf{ Blinker }&\cellcolor{\tableheadbgcolor}\textbf{ Interrupt Service  }\\\cline{1-2}
\endfirsthead
\hline
\endfoot
\hline
\cellcolor{\tableheadbgcolor}\textbf{ Blinker }&\cellcolor{\tableheadbgcolor}\textbf{ Interrupt Service  }\\\cline{1-2}
\endhead
\href{https://youtu.be/--iLaLC5cG0}{\texttt{ }} &\href{https://youtu.be/gr3OVOcgF4Q}{\texttt{ }}  \\\cline{1-2}
\end{longtabu}



\begin{DoxyItemize}
\item Drives 8 Servos. Demo at \href{https://wokwi.com/projects/356866133593965569}{\texttt{ $\ast$this Wokwi project$\ast$}}
\item Controls 4-\/legged Robot (8 servos) with ultrasound and IR remote. Demo code in $\sim$/examples/8\+\_\+kame
\end{DoxyItemize}

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{2}{|X[-1]}|}
\hline
\cellcolor{\tableheadbgcolor}\textbf{ Ultrasound Ranging }&\cellcolor{\tableheadbgcolor}\textbf{ Walking  }\\\cline{1-2}
\endfirsthead
\hline
\endfoot
\hline
\cellcolor{\tableheadbgcolor}\textbf{ Ultrasound Ranging }&\cellcolor{\tableheadbgcolor}\textbf{ Walking  }\\\cline{1-2}
\endhead
\href{https://youtu.be/pvBo-G87Fzw}{\texttt{ }} &\href{https://youtu.be/-zBb82UFZpA}{\texttt{ }}  \\\cline{1-2}
\end{longtabu}



\begin{DoxyItemize}
\item Bluetooth (H\+C-\/05) communication. Demo code in $\sim$/examples/9\+\_\+bluetooth
\item Wi\+Fi (n\+R\+F24\+L01s) communication. Demo code in $\sim$/examples/11\+\_\+rf 
\end{DoxyItemize}

\doxysubsection*{Benchmark}


\begin{DoxyItemize}
\item Classic 1 million cycles 
\begin{DoxyPre}
    > : inner 999 FOR 34 DROP NEXT ;⏎          \textbackslash{} inner loop (put 34 on stack then drop it)
    > : outer 999 FOR inner NEXT ;⏎            \textbackslash{} create the outer loop
    > : bench CLOCK DNEGATE outer CLOCK D+ ;⏎  \textbackslash{} CLOCK returns a double value
    > bench⏎                                   \textbackslash{} benchmark the 1000x1000 cycles
    > 25492 0 ok>                              \textbackslash{} 25492ms =\string~ 25.5us/cycle (with one blinking ISR running in the background)
    \end{DoxyPre}

\end{DoxyItemize}

\#\doxysection*{To Learn More About Forth?}

If your programming language exposure has been with C, Java, or even Python so far, F\+O\+R\+TH is quite {\bfseries{different}}. Quote Nick\+: {\itshape \char`\"{}\+It\textquotesingle{}s no functional or object oriented, it doesn\textquotesingle{}t have type-\/checking, and it basically has zero syntax\char`\"{}}. No syntax? So, anyway, before you dive right into the deep-\/end, here\textquotesingle{}s a good online materials.
\begin{DoxyItemize}
\item Interactive tutorial for F\+O\+R\+TH primer. It teaches you how F\+O\+R\+TH fundamentally works such as the numbers, the stack, and the dictionary. \begin{quote}
\href{https://skilldrick.github.io/easyforth/\#introduction}{\texttt{ $\ast$\+Easy Forth Tutorial by Nick Morgan$\ast$}} with a \href{https://wiki.forth-ev.de/lib/exe/fetch.php/en:projects:a-start-with-forth:05_easy_forth_v16_a5_withexp_comments.pdf?fbclid=IwAR0sHmgiDtnMRuQtJdVkhl9bmiitpgcjs4ZlIDVtlxrssMOmLBv0vesvmKQ}{\texttt{ $\ast$\+Writeup$\ast$}} by Juergen Pintaske. \end{quote}

\end{DoxyItemize}

To understand the philosophy of F\+O\+R\+TH, excellent online e-\/books are here free for you.
\begin{DoxyItemize}
\item Timeless classic for the history, paths, and thoughts behind F\+O\+R\+TH language. \begin{quote}
\href{https://www.forth.com/starting-forth/}{\texttt{ $\ast$\+Starting Forth by Leo Brodie$\ast$}}~\newline
 \href{http://thinking-forth.sourceforge.net}{\texttt{ $\ast$\+Thinking Forth by Leo Brodie$\ast$}} \end{quote}

\end{DoxyItemize}

\doxysubsection*{Build your own Forth}

Traditionally, the Forth image is build from low-\/level assembly and high-\/level Forth via a process called meta-\/compilation. See \href{https://www.ultratechnology.com/meta.html}{\texttt{ details here}}. Latest e\+Forth, from Dr. Ting, changed the process to build the entire image with C only. I follow the same philosophy. \begin{quote}


$>$ git clone \href{https://github.com/chochain/eForth1}{\texttt{ $\ast$https\+://github.com/chochain/e\+Forth1$\ast$}} onto your local directory

$>$ make rom \# to create \mbox{\hyperlink{eforth__rom_8c}{src/eforth\+\_\+rom.\+c}}

study how \mbox{\hyperlink{eforth__asm_8h}{src/eforth\+\_\+asm.\+h}}, and \mbox{\hyperlink{eforth__asm_8c}{src/eforth\+\_\+asm.\+c}} create Forth image

study how \mbox{\hyperlink{eforth__core_8h_a4bafcde45de1826f5d95260ec6143e39}{vm\+\_\+outer()}} in \mbox{\hyperlink{eforth__vm_8cpp}{src/eforth\+\_\+vm.\+cpp}} interacts with the R\+OM image

modify \mbox{\hyperlink{eforth__asm_8c}{src/eforth\+\_\+asm.\+c}} to build your version of e\+Forth

$>$ make \# to generate tests/eforth1 for debugging, or

use Arduino I\+DE to compile and upload

\end{quote}


\doxysubsection*{Performance Tuning ($\sim$15\% faster)}


\begin{DoxyItemize}
\item Check your Arduino I\+DE installed directory, say {\itshape C\+:\textbackslash{}\+Users\textbackslash{}myname\textbackslash{}\+App\+Data\textbackslash{}\+Local\textbackslash{}\+Arduino...} on Windows or {\itshape /home/myname/\+Arduino/...} on Linux,
\item Find the directory {\itshape hardware -\/$>$ arduino -\/$>$ avr},
\item With an editor, open the {\itshape \textquotesingle{}platform.\+txt\textquotesingle{}} file,
\item Find all three -\/Os compiler options (i.\+g. compiler.\+c.\+flags=-\/c -\/g -\/Os ...) \begin{quote}
change them to -\/O3 for speed, -\/Os (default) for smallest size, -\/O2 for somewhere in-\/between \end{quote}

\end{DoxyItemize}

\doxysubsection*{References to Dr. Ting\textquotesingle{}s Original}


\begin{DoxyItemize}
\item \href{https://chochain.github.io/eForth1/ref/1013_eForthAndZen.pdf}{\texttt{ {\itshape e\+Forth and Zen}}}
\item \href{https://chochain.github.io/eForth1/ref/The_Arduino_controlled_by_eForth.pdf}{\texttt{ {\itshape The Arduino controlled by e\+Forth}}}
\item \href{https://github.com/DRuffer/328eforth}{\texttt{ {\itshape 328e\+Forth mod for coin\+Forth by D. Ruffer}}}
\item \href{https://chochain.github.io/eForth1/ref/ceForth_33.doc}{\texttt{ {\itshape ce\+Forth\+\_\+33.\+doc -\/ original documentation}}}
\item \href{https://chochain.github.io/eForth1/ref/ceForth_33.cpp}{\texttt{ {\itshape ce\+Forth\+\_\+33.\+cpp -\/ source code in C}}}
\item \href{https://chochain.github.io/eForth1/ref/eforth_328.ino}{\texttt{ {\itshape eforth\+\_\+328.\+ino -\/ Arduino I\+DE teaser by Dr. Ting}}}
\end{DoxyItemize}

\doxysubsection*{For Projects small and large}


\begin{DoxyItemize}
\item A tiny 8-\/bit sytem at \href{https://github.com/TG9541/stm8ef}{\texttt{ {\itshape e\+Forth for S\+T\+M8}}} or \href{https://github.com/TG9541/stm8ef/wiki/STM8S-Programming\#flashing-the-stm8}{\texttt{ {\itshape S\+T\+M8 Programming}}}
\item A system with Wi\+Fi, and fancy stuffs at \href{https://esp32forth.appspot.com/ESP32forth.html}{\texttt{ {\itshape Esp32forth}}} or its \href{https://github.com/Esp32forth}{\texttt{ {\itshape Git\+Hub site}}} 
\end{DoxyItemize}